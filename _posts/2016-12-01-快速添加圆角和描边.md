---
layout:     post
title:      基于AudioContext直接播放AMR格式的短音频文件
subtitle:   关于音频原生API的使用
date:       2018-09-30
author:     CNJ
header-img: img/post-bg-audio-web.jpg
catalog: true
tags:
    - WEB
    - 开发技巧
---

# 前言

随着微信的兴起，语音聊天是一种与文字交流不同的交流方式。很多互联网产品，例如金融类APP、游戏类APP等除了会加入传统的文字聊天模块，有些APP也会加入语音聊天模块。

# 业务背景
一般语音的数据量比较大，通常会用amr格式作为存储格式，移动端APP可以调用底层模块进行读取amr格式的文件，但是如果开发的是WEB应用，就比较麻烦了，因为如果直接使用`<audio>`标签的src属性读取服务器文件，没办法识别amr格式文件。因此，引入了一个Web API [AudioContext](https://developer.mozilla.org/zh-CN/docs/Web/API/AudioContext/AudioContext) 。

# AudioContext
***写在最前***： AudioContext是一个**实验中**的新标准，换句话说，现在这篇博客的内容可能由于标准版本修订而有所改变，如果未来浏览器版本出现兼容性问题，需自行解决。

AduioContext是一个专门用于音频处理的接口，原理是将每一个音频节点拼接起来并进行相关处理。
针对不同浏览器进行相关处理后实例化*AudioContext*

```JavaScript
var AudioContext = window.AudioContext || window.webkitAudioContext;

var audioContext = new AudioContext(); //实例化AudioContext对象
```
支持AudioContext的浏览器版本如下表：
|    浏览器    |   Chrome      | Firefox(Gecko)|    IE  |  Opera
|:-----------:|:-----------: |:---------:|:---------:|:-----------:|
|   支持版本   |     	55.0    |   ?   | 不支持 |   42

**AudioContext**主要是用于处理数据流的API，因此首先需要处理从服务端AJAX请求回来的数据。
首先，定义AJAX请求返回的数据类型
```JavaScript
    xhr.responseType = 'blob'
```
将请求回来的二进制数据流进行Blob实例化，封装成音频类型的文件
```JavaScript
    self.blob = new Blob([xhr.response], {
        type: 'audio/mpeg'
    })
```
然后将